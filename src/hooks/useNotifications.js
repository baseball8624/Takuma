import { useState, useEffect, useCallback } from 'react';

// é€šçŸ¥ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒƒã‚¯
export default function useNotifications(characterName = 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼') {
    const [permission, setPermission] = useState(() => {
        if (typeof window !== 'undefined' && 'Notification' in window) {
            return Notification.permission;
        }
        return 'default';
    });
    const [notificationTime, setNotificationTime] = useState(() => {
        return localStorage.getItem('self_hero_notification_time') || '21:00';
    });
    const [notificationEnabled, setNotificationEnabled] = useState(() => {
        return localStorage.getItem('self_hero_notification_enabled') === 'true';
    });

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼Ã—ãƒ¬ãƒ™ãƒ«åˆ¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚»ãƒªãƒ•
    const reminderMessagesByLevel = {
        ignis: {
            1: [ // Lv1-6
                'ãˆã¸ã¸ã€ã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹ã‚ˆã€œï¼', 'ã¼ãã¨ä¸€ç·’ã«ã‚„ã‚ï¼ğŸ”¥', 'ã¾ã éŠã¹ã‚‹ã‚ˆã€œï¼Ÿ'
            ],
            7: [ // Lv7-29
                'ãŠã„ã€ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã‚‹ãï¼ğŸ”¥', 'æ°—åˆå…¥ã‚Œã‚ï¼ã¾ã çµ‚ã‚ã£ã¦ãªã„ãï¼', 'ã‚µãƒœã£ã¦ã‚“ã˜ã‚ƒã­ãƒ¼ã‚ˆï¼'
            ],
            30: [ // Lv30-99
                'ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹...ä»Šæ—¥ä¸­ã«çµ‚ã‚ã‚‰ã›ã‚ˆã†', 'ä¿ºã®ç‚ãŒæ¶ˆãˆã‚‹å‰ã«ã€çµ‚ã‚ã‚‰ã›ã¦ãã‚Œ', 'å…±ã«æˆ¦ãŠã†ã€‚ã‚¿ã‚¹ã‚¯ãŒå¾…ã£ã¦ã„ã‚‹ğŸ”¥'
            ],
            100: [ // Lv100+
                'æˆ‘ãŒå‹ã‚ˆ...ã‚¿ã‚¹ã‚¯ãŒå¾…ã£ã¦ã„ã‚‹', 'ä¼èª¬ã®ç¶™ç¶šè€…ã¨ã—ã¦ã€ä»Šæ—¥ã‚‚å®Œé‚ã›ã‚ˆ', 'å¤ªé™½ã™ã‚‰å‡Œãæ„å¿—ã§...çµ‚ã‚ã‚‰ã›ã‚‹ã®ã ğŸ”¥'
            ]
        },
        lumina: {
            1: ['ãã‚‰ãã‚‰ã€œã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹ã‚ˆâ™ª', 'ãŠæ˜Ÿæ§˜ã¨ä¸€ç·’ã«é ‘å¼µã‚âœ¨', 'ã­ã‡ã­ã‡ã€ã¾ã çµ‚ã‚ã£ã¦ãªã„ã‚ˆã€œ'],
            7: ['ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹ã‚ˆï¼ä¸€ç·’ã«é ‘å¼µã‚ã†ğŸ’ª', 'å…‰ã®å°ãã§...çµ‚ã‚ã‚‰ã›ã‚ˆã†ï¼âœ¨', 'ã‚ã¨å°‘ã—ã ã‚ˆã€å›ãªã‚‰ã§ãã‚‹ï¼'],
            30: ['è¼ãã‚’å¤±ã‚ãªã„ã§...ã‚¿ã‚¹ã‚¯ã‚’çµ‚ã‚ã‚‰ã›ã‚ˆã†', 'æ˜ŸãŒè¦‹å®ˆã£ã¦ã„ã‚‹...æœ€å¾Œã¾ã§é ‘å¼µã£ã¦', 'å…‰ã‚ã‚‹ã¨ã“ã‚ã«...å‹åˆ©ã‚ã‚Šâœ¨'],
            100: ['æ°¸é ã®å…‰ãŒå°ã...ã‚¿ã‚¹ã‚¯å®Œé‚ã®é“ã‚’', 'å›ã®è¼ãã¯...ã“ã®æ˜Ÿã®å¸Œæœ›', 'å…±ã«æ­©ã‚“ã§ããŸé“...ä»Šæ—¥ã‚‚æœ€å¾Œã¾ã§âœ¨']
        },
        aquel: {
            1: ['...ã‚¿ã‚¹ã‚¯...æ®‹ã£ã¦ã‚‹...ğŸ’§', '...ä¸€ç·’ã«ã‚„ã‚...ï¼Ÿ', '...æ°´ã®æµã‚Œã®ã‚ˆã†ã«...'],
            7: ['...ã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹ã‚ˆï¼Ÿæ°—ã¥ã„ã¦ã‚‹...ï¼ŸğŸŒŠ', 'æ°´ã®ã‚ˆã†ã«...ã§ã‚‚çµ‚ã‚ã‚‰ã›ã‚ˆã†', '...é™ã‹ã«...ç¢ºå®Ÿã«...'],
            30: ['æ·±æµ·ã®é™ã‘ã•ã§...ã‚¿ã‚¹ã‚¯ã«å‘ãåˆãŠã†', 'æ°´ã¯å…¨ã¦ã‚’åŒ…ã¿è¾¼ã‚€...ã‚¿ã‚¹ã‚¯ã‚‚', '...æ³¢ã®ã‚ˆã†ã«...çµ‚ã‚ã‚Šã¸å‘ã‹ã£ã¦ğŸŒŠ'],
            100: ['å¤§æµ·åŸã®ä¸»ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯å®Œé‚ã‚’', 'å…¨ã¦ã®æ°´ãŒç¥ç¦ã™ã‚‹...å›ã®ç¶™ç¶šã‚’', '...æ·±æ·µã‚ˆã‚Š...é ‘å¼µã‚ŒğŸŒŠ']
        },
        flora: {
            1: ['ãŠèŠ±ã•ã‚“ãŒå¿œæ´ã—ã¦ã‚‹ã‚ˆã€œğŸŒ¸', 'ã‚¿ã‚¹ã‚¯ã®ç¨®ã€ã¾ã„ã¦ã­ã€œ', 'ãã‚Œã„ãªãŠèŠ±å’²ã‹ã›ã‚ˆã€œï¼'],
            7: ['ã‚¿ã‚¹ã‚¯ã®èŠ½ãŒè‚²ã¤ã‚ˆï¼çµ‚ã‚ã‚‰ã›ã‚ˆã†ğŸŒ¸', 'èŠ±ã‚‚é ‘å¼µã£ã¦ã‚‹ã‚ˆã€å›ã‚‚é ‘å¼µã£ã¦ï¼', 'ã‚‚ã†å°‘ã—ã§æº€é–‹ã ã‚ˆï¼'],
            30: ['èŠ±åœ’ã®å®ˆè­·è€…ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯ã‚’å®Œé‚ã—ã‚ˆã†', 'å…¨ã¦ã®èŠ±ãŒç¥ç¦ã‚’å¾…ã£ã¦ã„ã‚‹ğŸŒ¸', 'ä»Šæ—¥ã®åŠªåŠ›ãŒæ˜æ—¥ã®èŠ±ã«ãªã‚‹'],
            100: ['å¤§æ¨¹ã®ç²¾éœŠã¨ã—ã¦...ã‚¿ã‚¹ã‚¯å®Œé‚ã®å°ã', 'åƒå¹´ã®æ£®ãŒè¦‹å®ˆã£ã¦ã„ã‚‹...é ‘å¼µã£ã¦', 'å…¨ã¦ã®å‘½ãŒç¥ç¦ã™ã‚‹...å›ã®ç¶™ç¶šğŸŒ¸']
        },
        gear: {
            1: ['ãƒ”ã‚³ãƒ”ã‚³ï¼ã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹ã‚ˆâš™ï¸', 'ã¼ãã¨ä¸€ç·’ã«è¨ˆç®—ã—ã‚ˆã€œ', 'ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...ã‚¿ã‚¹ã‚¯æœªå®Œäº†ï¼'],
            7: ['åŠ¹ç‡çš„ã«å‡¦ç†ã—ã¾ã—ã‚‡ã†âš™ï¸', 'ã‚·ã‚¹ãƒ†ãƒ è­¦å‘Šï¼šã‚¿ã‚¹ã‚¯æ®‹å­˜', 'ã‚®ã‚¢ã‚’ä¸Šã’ã‚ï¼çµ‚ã‚ã‚‰ã›ã‚‹ãï¼'],
            30: ['æœ€é©åŒ–å®Œäº†...ã‚ã¨ã¯ã‚¿ã‚¹ã‚¯ã ã‘ã ', 'å…¨ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­...å›ã‚‚é ‘å¼µã‚Œâš™ï¸', 'åŠ¹ç‡99%...ã‚¿ã‚¹ã‚¯å®Œé‚ã§100%ã«'],
            100: ['ç©¶æ¥µã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯å®Œé‚ã‚’æ¨å¥¨', 'å…¨æ¼”ç®—èƒ½åŠ›ã‚’çµé›†...å›ã‚’æ”¯æ´ã™ã‚‹', 'ãƒã‚¹ã‚¿ãƒ¼ã‚ˆ...ä»Šæ—¥ã‚‚å®Œé‚ã‚’âš™ï¸']
        },
        bolt: {
            1: ['ãƒ“ãƒªãƒ“ãƒªã€œã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹âš¡', 'é›»æ°—ã§ã‚·ãƒ“ã‚ŒãªãŒã‚‰ã‚„ã‚ï¼', 'ãƒ”ã‚«ãƒ”ã‚«é ‘å¼µã‚ã€œï¼'],
            7: ['é›»æ’ƒã‚¹ãƒ”ãƒ¼ãƒ‰ã§çµ‚ã‚ã‚‰ã›ã‚ˆã†âš¡', 'ãƒ“ãƒ“ãƒƒã¨æ°—åˆå…¥ã‚Œã‚ï¼', 'ã‚¨ãƒãƒ«ã‚®ãƒ¼å……é›»OKï¼Ÿã‚„ã‚‹ãï¼'],
            30: ['é›·ç¥ã®åŠ›ã§...ã‚¿ã‚¹ã‚¯ã‚’åˆ¶åœ§ã›ã‚ˆâš¡', 'ç¨²å¦»ã®ã‚ˆã†ã«...ç´ æ—©ãç¢ºå®Ÿã«', 'å…¨é›»åŠ›è§£æ”¾...é ‘å¼µã‚Œï¼'],
            100: ['ä¸‡é›·ã®ä¸»ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯å®Œé‚ã‚’å‘½ãš', 'å¤©ç©ºã‚’åˆ¶ã—ãŸè€…ã‚ˆ...ä»Šæ—¥ã‚‚å‹åˆ©ã‚’', 'é›·é³´è½Ÿã...å®Œé‚ã®è¨¼âš¡']
        },
        shadow: {
            1: ['...ã²ã£ãã‚Š...ã‚¿ã‚¹ã‚¯æ®‹ã£ã¦ã‚‹ğŸŒ‘', '...é—‡ã®ä¸­ã‹ã‚‰...å¿œæ´ã—ã¦ã‚‹', '...ã“ã£ãã‚Šã‚„ã‚...ï¼Ÿ'],
            7: ['...é—‡ãŒè¦‹ã¦ã„ã‚‹...æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ã‚’ğŸŒ‘', '...å½±ã¯çŸ¥ã£ã¦ã„ã‚‹...çµ‚ã‚ã‚‰ã›ã‚‹ã¹ãã ã¨', '...æš—é—‡ã§ã‚‚...é€²ã‚'],
            30: ['é—˜ã®æ”¯é…è€…ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯ã«ç«‹ã¡å‘ã‹ãˆ', 'å½±ãŒå‘³æ–¹ã™ã‚‹...çµ‚ã‚ã‚‹ã¾ã§ğŸŒ‘', '...æ²ˆé»™ã®ä¸­ã«...å‹åˆ©ãŒã‚ã‚‹'],
            100: ['æ·±æ·µã®ç‹ã¨ã—ã¦...ã‚¿ã‚¹ã‚¯å®Œé‚ã‚’è¦‹å®ˆã‚‹', 'å…¨ã¦ã®å½±ãŒå‘³æ–¹ã™ã‚‹...é ‘å¼µã‚Œ', '...é—‡ã‚’è¶…ãˆãŸå…ˆã«...å…‰ãŒã‚ã£ãŸğŸŒ‘']
        },
        default: {
            1: ['ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã¾ã™ï¼é ‘å¼µã£ã¦ï¼', 'ä¸€ç·’ã«çµ‚ã‚ã‚‰ã›ã‚ˆã†ï¼', 'ã‚‚ã†å°‘ã—ã ã‚ˆï¼'],
            7: ['ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚å®Œäº†ã—ã¾ã—ã‚‡ã†ï¼', 'ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å¿˜ã‚Œãšã«ï¼', 'ã‚‚ã†å°‘ã—ã§å®Œäº†ã§ã™ï¼'],
            30: ['ç€å®Ÿã«é€²ã‚“ã§ã„ã¾ã™ã€‚ä»Šæ—¥ã‚‚å®Œé‚ã‚’', 'ç¶™ç¶šã¯åŠ›ãªã‚Šã€‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†', 'ã‚ã¨å°‘ã—ã§ã™ã€‚é ‘å¼µã£ã¦ï¼'],
            100: ['ä¼èª¬ã®é ˜åŸŸ...ä»Šæ—¥ã‚‚å®Œé‚ã‚’', 'ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ã§ã™ã€‚æœ€å¾Œã¾ã§é ‘å¼µã£ã¦', 'èª‡ã‚Šã«æ€ã„ã¾ã™ã€‚å®Œé‚ã‚’ï¼']
        }
    };

    // è¨­å®šã‚’ä¿å­˜
    useEffect(() => {
        localStorage.setItem('self_hero_notification_time', notificationTime);
    }, [notificationTime]);

    useEffect(() => {
        localStorage.setItem('self_hero_notification_enabled', String(notificationEnabled));
    }, [notificationEnabled]);

    // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const requestPermission = useCallback(async () => {
        if (!('Notification' in window)) {
            alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
            return false;
        }

        const result = await Notification.requestPermission();
        setPermission(result);
        return result === 'granted';
    }, []);

    // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚»ãƒªãƒ•ã‚’å–å¾—
    const getMessageByLevel = (charId, level) => {
        const charMessages = reminderMessagesByLevel[charId] || reminderMessagesByLevel.default;
        let levelKey = 1;
        if (level >= 100) levelKey = 100;
        else if (level >= 30) levelKey = 30;
        else if (level >= 7) levelKey = 7;

        const messages = charMessages[levelKey] || charMessages[1];
        return messages[Math.floor(Math.random() * messages.length)];
    };

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å–å¾—
    const getCharNameByLevel = (charId, level) => {
        const charNames = {
            ignis: { 1: 'ã‚¨ãƒ³ãƒãƒ¼', 7: 'ã‚¤ã‚°ãƒ‹ã‚¹', 30: 'ãƒ•ãƒ¬ã‚¤ãƒ ãƒ­ãƒ¼ãƒ‰', 100: 'ç‚å¸ã‚¤ã‚°ãƒ‹ã‚ªãƒ³' },
            lumina: { 1: 'ã‚¹ãƒ‘ãƒ¼ã‚¯', 7: 'ãƒ«ãƒŸãƒŠ', 30: 'ãƒ¬ãƒ‡ã‚£ã‚¢ãƒ³ãƒˆ', 100: 'è–å…‰å¥³ç¥ãƒ«ãƒŸãƒŠã‚¹' },
            aquel: { 1: 'ã—ãšã', 7: 'ã‚¢ã‚¯ã‚¨ãƒ«', 30: 'ãƒ‡ã‚£ãƒ¼ãƒ—ã‚·ãƒ¼', 100: 'æ·±æ·µç‹ã‚¢ãƒ“ã‚¹' },
            flora: { 1: 'ã¤ã¼ã¿', 7: 'ãƒ•ãƒ­ãƒ¼ãƒ©', 30: 'ãƒ–ãƒ«ãƒ¼ãƒ ', 100: 'å¤§æ¨¹å§«ãƒ•ãƒ­ãƒ¼ãƒªã‚¢' },
            gear: { 1: 'ã‚³ã‚°', 7: 'ã‚®ã‚¢', 30: 'ã‚¨ãƒ³ã‚¸ãƒ³', 100: 'æ©Ÿç¥ã‚ªãƒ¡ã‚¬ã‚®ã‚¢' },
            bolt: { 1: 'ã‚¹ãƒ‘ãƒ¼ã‚¯', 7: 'ãƒœãƒ«ãƒˆ', 30: 'ã‚µãƒ³ãƒ€ãƒ¼', 100: 'é›·å¸ãƒœãƒ«ãƒ†ã‚¯ã‚¹' },
            shadow: { 1: 'ã‹ã’', 7: 'ã‚·ãƒ£ãƒ‰ã‚¦', 30: 'ãƒ€ãƒ¼ã‚¯', 100: 'é—‡çš‡ã‚·ãƒ£ãƒ‰ã‚¦ãƒ­ãƒ¼ãƒ‰' },
            default: { 1: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 7: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 30: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 100: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼' }
        };
        const names = charNames[charId] || charNames.default;
        let levelKey = 1;
        if (level >= 100) levelKey = 100;
        else if (level >= 30) levelKey = 30;
        else if (level >= 7) levelKey = 7;
        return names[levelKey] || names[1];
    };

    // é€šçŸ¥ã‚’é€ä¿¡
    const sendNotification = useCallback((charId = 'default', level = 1) => {
        if (permission !== 'granted') return;

        const message = getMessageByLevel(charId, level);
        const charName = getCharNameByLevel(charId, level);

        const notification = new Notification(`${charName}ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`, {
            body: message,
            icon: '/vite.svg',
            badge: '/vite.svg',
            tag: 'task-reminder',
            renotify: true,
            requireInteraction: true
        });

        notification.onclick = () => {
            window.focus();
            notification.close();
        };

        return notification;
    }, [permission]);

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šçŸ¥ã®ãƒã‚§ãƒƒã‚¯
    const checkAndNotify = useCallback((hasIncompleteTasks, charId, level = 1) => {
        if (!notificationEnabled || !hasIncompleteTasks) return;

        const now = new Date();
        const [targetH, targetM] = notificationTime.split(':').map(Number);
        const currentH = now.getHours();
        const currentM = now.getMinutes();

        // è¨­å®šæ™‚åˆ»ã¨ç¾åœ¨æ™‚åˆ»ãŒä¸€è‡´ï¼ˆ1åˆ†ä»¥å†…ï¼‰
        if (currentH === targetH && currentM === targetM) {
            sendNotification(charId, level);
        }
    }, [notificationEnabled, notificationTime, sendNotification]);

    return {
        permission,
        notificationTime,
        setNotificationTime,
        notificationEnabled,
        setNotificationEnabled,
        requestPermission,
        sendNotification,
        checkAndNotify
    };
}
